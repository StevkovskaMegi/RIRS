name: Full CI/CD Pipeline

on:
  push:
    branches:
      - main
      - production
  pull_request:
    branches:
      - main
      - production

jobs:
  # Backend CI
  backend-ci:
    name: Backend CI
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 22

    - name: Cache Dependencies
      uses: actions/cache@v3
      with:
        path: ./backend/node_modules
        key: ${{ runner.os }}-backend-${{ hashFiles('./backend/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-backend-

    - name: Install Dependencies
      run: |
        cd backend
        npm ci

    - name: Build Backend
      run: |
        cd backend
        if [ -f "package.json" ] && grep -q '"build":' package.json; then
          npm run build
        else
          echo "No build script found, skipping build."
        fi

    - name: Run Tests
      run: |
        cd backend
        npm test -- --coverage

    - name: Upload Coverage Report
      if: success()
      uses: actions/upload-artifact@v3
      with:
        name: backend-coverage
        path: ./backend/coverage/

  # Frontend CI
  frontend-ci:
    name: Frontend CI
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 22

    - name: Cache Dependencies
      uses: actions/cache@v3
      with:
        path: ./frontend/node_modules
        key: ${{ runner.os }}-frontend-${{ hashFiles('./frontend/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-frontend-

    - name: Install Dependencies
      run: |
        cd frontend
        npm ci

    - name: Build Frontend
      run: |
        cd frontend
        if [ -f "package.json" ] && grep -q '"build":' package.json; then
          npm run build
        else
          echo "No build script found, skipping build."
        fi

    - name: Run Tests
      run: |
        cd frontend
        npm test -- --coverage

    - name: Upload Coverage Report
      if: success()
      uses: actions/upload-artifact@v3
      with:
        name: frontend-coverage
        path: ./frontend/coverage/